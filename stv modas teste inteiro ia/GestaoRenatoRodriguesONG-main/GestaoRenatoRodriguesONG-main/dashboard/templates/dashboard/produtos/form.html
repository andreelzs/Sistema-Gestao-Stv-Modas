{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar Produto{% else %}Adicionar Produto{% endif %} - STV Modas
{% endblock %}

{% block content %}
    <h2>{% if form.instance.pk %}Editar Produto{% else %}Adicionar Novo Produto{% endif %}</h2>
    <p><a href="{% url 'dashboard:lista_produtos' %}" class="button">Voltar para a Lista de Produtos</a></p>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <h3>Variações</h3>
        {{ variacao_formset.management_form }}
        <div id="variacao-formset-container">
            {% for formset_form in variacao_formset %}
                <div class="inline-formset-row">
                    {{ formset_form.as_p }}
                    {% if formset_form.instance.pk %}
                        <p>Imagens da Variação:</p>
                        {% for img_form in imagem_formset %}
                            {% if img_form.instance.produto_id == formset_form.instance.produto_base.id %} {# Isso não está correto, preciso associar imagens à variação #}
                                {{ img_form.as_p }}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            {% endfor %}
            <div class="add-row-formset">
                <a href="#" class="button add-variacao-button">Adicionar Variação</a>
            </div>
        </div>

        <h3>Imagens do Produto Base</h3>
        {{ imagem_formset.management_form }}
        <div id="imagem-formset-container">
            {% for formset_form in imagem_formset %}
                <div class="inline-formset-row">
                    {{ formset_form.as_p }}
                </div>
            {% endfor %}
            <div class="add-row-formset">
                <a href="#" class="button add-imagem-button">Adicionar Imagem</a>
            </div>
        </div>

        <button type="submit" class="button">Salvar Produto</button>
    </form>

    <script>
        (function($) {
            $(document).ready(function() {
                // Lógica para adicionar/remover formsets dinamicamente (para Variações e Imagens)
                const setupInlineFormset = (containerId, prefix, addBtnClass) => {
                    const container = $(`#${containerId}`);
                    const totalFormsInput = $(`#id_${prefix}-TOTAL_FORMS`);
                    const addRowButton = container.find(`.${addBtnClass}`);
                    const emptyForm = container.find('.empty-form:first'); // O form vazio para clonar

                    // Esconde o empty form para não ser exibido
                    emptyForm.hide();

                    addRowButton.on('click', function(e) {
                        e.preventDefault();
                        const currentForms = parseInt(totalFormsInput.val());
                        const newForm = emptyForm.clone(true); // Clonar com eventos
                        
                        newForm.removeClass('empty-form').addClass('inline-formset-row').attr('id', `${prefix}-${currentForms}`);
                        newForm.html(newForm.html().replace(/__prefix__/g, currentForms));

                        // Insere a nova linha antes do emptyForm (que está escondido)
                        newForm.insertBefore(emptyForm);
                        totalFormsInput.val(currentForms + 1);

                        // Limpa os valores dos campos clonados
                        newForm.find('input, select, textarea').val('');
                        newForm.show(); // Exibe a nova linha
                    });

                    // Lógica para marcar DELETE (se houver checkbox de delete)
                    container.on('change', 'input[name$="-DELETE"]', function() {
                        const row = $(this).closest('.inline-formset-row');
                        if ($(this).is(':checked')) {
                            row.hide(); // Esconde a linha se marcada para deletar
                        } else {
                            row.show(); // Mostra a linha se desmarcada
                        }
                    });
                };

                setupInlineFormset('variacao-formset-container', 'variacoes', 'add-variacao-button');
                setupInlineFormset('imagem-formset-container', 'imagens', 'add-imagem-button');
            });
        })(django.jQuery);
    </script>
{% endblock %}
